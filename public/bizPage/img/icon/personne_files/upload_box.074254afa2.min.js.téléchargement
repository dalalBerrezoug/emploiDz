!function(e,$){function x(e,t,n,o){if(!e.cropbox)return!1;var r,i=$('[type="text/x-emp-tpl"][id=crop-controls]').text(),a=e.data(),d=/\]$/.test(t)?t.replace(/\]$/,"_crop]"):t+"_crop",p=a.xInput||$('<Input type="hidden" name="'+d+'[x]" value="">'),c=a.yInput||$('<Input type="hidden" name="'+d+'[y]" value="">'),l=a.hInput||$('<Input type="hidden" name="'+d+'[h]" value="">'),u=a.wInput||$('<Input type="hidden" name="'+d+'[w]" value="">');return a.inserted||(p.insertAfter(e),c.insertAfter(e),l.insertAfter(e),u.insertAfter(e),e.data({w:u,h:l,x:p,y:c,inserted:!0})),(r=e.cropbox({width:n||e.width(),height:o||e.height(),controls:i}).on("cropbox",function(e,t){p.val(t.cropX),c.val(t.cropY),l.val(t.cropH),u.val(t.cropW)}).data("cropbox")).$frame.on("click",".crop-zoom-in",function(){r.zoomIn()}),r.$frame.on("click",".crop-zoom-out",function(){r.zoomOut()}),r}function n(r){var e,t,i,a,n=r.attr("name"),d="reselect",o=$('[type="text/x-emp-tpl"][id=image-upload-template]').text(),p=$(o).insertBefore(r),c=r.data(),l=c.downloadUrl||"",u=r.val(),s=u&&l&&c.downloadUrl+u||"",f=p.find(".upload-container"),h=p.find(".upload-preview"),m=p.find(".upload-empty-image"),g=p.find(".error-message"),w=g.find(".retry-btn");p.css({width:c.width||200,height:c.height||200}),p.append(r),v(m),v(g.hide()),h.bind("error",function(){h.unbind("error"),h.hide(),m.show()}),w.on("click",function(){if("reselect"===d)return e.trigger("click");t.retry(i)}),t=new qq.FineUploaderBasic({multiple:!1,button:f.find(".upload-element").get(0),request:{inputName:"upload",filenameParam:"uploadFileName",endpoint:c.uploadUrl},callbacks:{onComplete:function(e,t,n){var o=n.data&&n.data.attachment_id;if(m.hide(),n&&n.success)return a&&a.remove(),h.attr("src",c.downloadUrl+o),g.hide(),a=x(h,t,c.width,c.height),r.val(o);n.error?(d="reselect",g.find("p").text(n.error)):(i=e,d="retry",g.find("p").text("Erreur inconnue!")),g.show()}}}),p.on("click",".upload-btn",function(){e.trigger("click")}),e=f.find(".upload-element input"),function(t,e){new qq.DragAndDrop({dropZoneElements:e,classes:{dropActive:"cssClassToAddToDropZoneOnEnter"},callbacks:{processingDroppedFiles:function(){},processingDroppedFilesComplete:function(e){t.addFiles(e)}}})}(t,[p.get(0)]),s?(h.attr("src",s),m.hide()):(h.hide(),m.show()),x(h,n,c.width,c.height)}function v(e){(e=$(e)).css({position:"absolute",top:"50%",left:"50%",margin:"-"+e.height()/2+"px 0 0 -"+e.width()/2+"px"})}$(function(){var e,t=$("[data-widget=upload-image]");for(e=0;e<t.length;e+=1)n($(t[e]))})}("undefined"!=typeof exports&&exports,"undefined"!=typeof jQuery&&jQuery);